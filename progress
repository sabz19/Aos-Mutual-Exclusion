#!/bin/bash

PROJDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

TEMP=.progresstemp

NETID=$(cat $PROJDIR/.netidtemp)
DOMAIN=utdallas.edu

#command line arguments
CONFIGPATH=$PROJDIR/config
CONFIG=$CONFIGPATH/$(cat $PROJDIR/.configtemp)

PROJDIRSCRIPT='$(echo $AOSMEROOT)'
REMOTEOUT=$PROJDIRSCRIPT/out

printed=0
done=0
total=0

COLS=$(stty size | cut -f2 -d" ")

cat $CONFIG | sed -e "s/#.*//" | sed -e "/^\s*$/d" |
(
	read i
	nodes=$(echo $i | cut -f1 -d" ")
	mesgs=$(echo $i | cut -f4 -d" ")
    total=$(($nodes * $mesgs))
    
    touch $TEMP
    echo $done > $TEMP
    
    while [ $(cat $TEMP) -lt $total ]; do
    (
        sleep 3
        n=0
        EXC=""
        while [ $n -lt $nodes ]; do
            EXC+="cat $REMOTEOUT/Kern$n.out 2>/dev/null; echo;"
            n=$(($n + 1))
        done
        done=$( ( ssh $NETID@dc01.$DOMAIN "$EXC" | grep Granting | wc | sed 's/^ *//' | cut -f1 -d' ' ) )
        donecolsprod=$(($done * $COLS))
        bars=$(($donecolsprod / $total))
        toprint=$(($bars - $printed))
        printf "\r"
        eval "printf '%0.s=' {1..$toprint}"
        echo $done > $TEMP
    )
    done
    
    rm $TEMP

)
